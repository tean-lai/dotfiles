import{t as a,B as m,s as i,d as w,a as o,p as _,b as S,c as v,e as b}from"./BLLock-n8n7x0Gc.js";const g=[{id:"first_menu",title:"Browser Lock",childs:[{id:"lock_menu",title:a("context_menu.lock_browser"),childs:[{id:"lock_now",title:a("context_menu.lock_now"),childs:[]}]},{id:"settings",title:a("context_menu.open_settings"),childs:[]}]}],k=(e=void 0,t=null)=>{t!=null&&(chrome.contextMenus.create({id:t.id,title:t.title,contexts:["all"],parentId:e}),t.childs!=null&&Object.values(t.childs).forEach(s=>{s!=null&&k(t.id,s)}))},d={listeners(e){switch(e.menuItemId){case"settings":chrome.runtime.openOptionsPage();break;case"lock_now":m.lockTheBrowser("manual");break}},registerListener(){chrome.contextMenus.onClicked.hasListener(d.listeners)&&chrome.contextMenus.onClicked.removeListener(d.listeners),chrome.contextMenus.onClicked.addListener(d.listeners)},register(){return new Promise(e=>{chrome.contextMenus.removeAll(()=>{k(void 0,g==null?void 0:g.at(0)),e(!0)})})},reRegister(){}},h={async shortCutListener(e){var t;(t=i.mainStorage.setting.short_cut_lock)!=null&&t.active&&e==="lock_browser_now_fixed"&&m.lockTheBrowser("manual")},register(){console.log("CML registered!!!"),chrome.commands.onCommand.hasListener(h.shortCutListener)&&chrome.commands.onCommand.removeListener(h.shortCutListener),chrome.commands.onCommand.addListener(h.shortCutListener)}},r={interval:null,listener(e){e==="idle"?r.idled():e==="active"&&r.activated()},register:()=>{var e,t,s;chrome.idle.setDetectionInterval((((t=(e=i.mainStorage.setting)==null?void 0:e.idle_mode)==null?void 0:t.duration)||1)*60),((s=i.mainStorage.setting.idle_mode)==null?void 0:s.active)!==!1&&(chrome.idle.onStateChanged.hasListener(r.listener)&&chrome.idle.onStateChanged.removeListener(r.listener),chrome.idle.onStateChanged.addListener(r.listener))},idled(){chrome.storage.session.get(["sessionStorage"]).then(e=>{if(e.sessionStorage===void 0)return;const t=JSON.parse(e.sessionStorage);t.lock.locked&&t.lock.popup===null||chrome.tabs.query({audible:!0}).then(s=>{s.length<=0&&(r.interval!==null&&clearTimeout(r.interval),r.notify(),r.interval=setTimeout(()=>{m.lockTheBrowser("manual")},5e3))})})},activated(){console.info("ACTIVE STATE"),r.interval!==null&&(clearTimeout(r.interval),r.clearNotification())},notify(){var e,t;((t=(e=i.mainStorage.setting)==null?void 0:e.idle_mode)==null?void 0:t.notify)===!0&&chrome.notifications.create(w().unix().toString(),{type:"basic",iconUrl:chrome.runtime.getURL("src/assets/icons/128-logo.png"),title:a("idle_lock.locking_in",{duration:5}),message:a("idle_lock.lock_description")},s=>{i.tempStorage.notified.push({id:s,type:"idle_notification"}),i.save()})},clearNotification(){i.tempStorage.notified.forEach(e=>{e.type==="idle_notification"&&chrome.notifications.clear(e.id)})}},f={messageListener(e,t,s){console.log(e,t),s({status:"ok"})},register(){chrome.runtime.onMessage.hasListener(f.messageListener)||chrome.runtime.onMessage.addListener(f.messageListener)}},u={async tabCreatedListener(e){var t,s;try{await o.refresh(),o.sessionStorage.lock.locked&&((t=o.sessionStorage.lock.popup)!=null&&t.id||await _.open(),((s=o.sessionStorage.lock.popup)==null?void 0:s.id)!=e.windowId&&chrome.tabs.remove(e.id??0).catch(()=>{}))}catch(c){console.error(c)}},registerListeners(){chrome.tabs.onCreated.hasListener(u.tabCreatedListener)&&chrome.tabs.onCreated.removeListener(u.tabCreatedListener),chrome.tabs.onCreated.addListener(u.tabCreatedListener)}},l={async windowCreatedListener(e){var t;await o.refresh(),o.sessionStorage.lock.locked?((t=o.sessionStorage.lock.popup)==null?void 0:t.id)!==e.id&&e.id&&e.id>-1&&chrome.notifications.create(w().unix().toString(),{type:"basic",iconUrl:chrome.runtime.getURL("src/assets/icons/128-logo.png"),title:"Browser Lock",message:a("service.error.browser_is_locked_cant_open_new_window")}):o.sessionStorage.lock.auto_locked===!1&&await m.lockTheBrowser("auto")},async windowRemovedListener(e){var t;if(await o.refresh(),o.sessionStorage.lock.locked)e===((t=o.sessionStorage.lock.popup)==null?void 0:t.id)&&(o.sessionStorage.lock.popup=null,await o.save());else try{(await chrome.windows.getAll()).length<=0&&(o.sessionStorage.lock.auto_locked=!1,await o.save())}catch{}},register(){chrome.windows.onCreated.hasListener(l.windowCreatedListener)||chrome.windows.onCreated.addListener(l.windowCreatedListener),chrome.windows.onRemoved.hasListener(l.windowRemovedListener)||chrome.windows.onRemoved.addListener(l.windowRemovedListener)}},C={register(){return Promise.all([u.registerListeners(),S.listeners(),l.register(),f.register(),h.register(),r.register(),d.registerListener()])}},n={welcome_url:"https://browserlock.io/installed/welcome?extid="+chrome.runtime.id,update_url:"https://browserlock.io/installed/update?extid="+chrome.runtime.id,async onInstalled(){chrome.storage.session.get(["sessionStorage"]).then(e=>{if(e.sessionStorage===void 0)return;const t=JSON.parse(e.sessionStorage);t.lock.locked===!0?t.lock.open_after.includes(n.welcome_url)||t.lock.open_after.push(n.welcome_url):chrome.tabs.create({url:n.welcome_url})})},async onUpdate(e="2.0.0"){const t=`${n.update_url}&version=${e}`;chrome.storage.session.get(["sessionStorage"]).then(s=>{if(s.sessionStorage===void 0)return;const c=JSON.parse(s.sessionStorage);c.lock.locked===!0?c.lock.open_after.includes(t)||c.lock.open_after.push(t):chrome.tabs.create({url:t})})}},y=async()=>{i.registerListener(),await Promise.all([i.refresh(),o.refresh(),d.register()]),chrome.notifications.getAll(e=>{Object.keys(e).forEach(t=>{chrome.notifications.clear(t)})}),Promise.all([C.register(),b.check()]).then(([e])=>{if(!e)throw{code:"BL-BOOTSTRAP-FAILED",status:!1,message:"Bootstrap Failed. Please try to restart your browser."}})};console.log(`BG Loaded, browser is: ${v.browser}`);y();const p=e=>{var t;e.reason==="install"?(chrome.runtime.openOptionsPage(),n.onInstalled()):e.reason==="update"&&(chrome.runtime.openOptionsPage(),n.onUpdate(((t=chrome.runtime.getManifest())==null?void 0:t.version)??"2.0.1"))},L=()=>{m.lockTheBrowser("auto")};chrome.runtime.setUninstallURL("https://browserlock.io/installed/uninstall");chrome.runtime.onInstalled.hasListener(p)||chrome.runtime.onInstalled.addListener(p);chrome.runtime.onStartup.hasListener(L)||chrome.runtime.onStartup.addListener(L);
